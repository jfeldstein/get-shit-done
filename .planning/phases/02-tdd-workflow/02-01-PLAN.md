---
phase: 02-tdd-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/config.json
  - get-shit-done/templates/config.json
  - commands/gsd/plan-phase.md
  - agents/gsd-planner.md
autonomous: true

must_haves:
  truths:
    - Planner receives tdd_preference from config when planning
    - Planner creates type: tdd plans when heuristic applies and preference allows
    - Config supports workflow.tdd_preference with default/always/never
  artifacts:
    - path: .planning/config.json
      provides: workflow.tdd_preference setting
      contains: "tdd_preference"
    - path: commands/gsd/plan-phase.md
      provides: tdd_preference passed to planner spawn
    - path: agents/gsd-planner.md
      provides: TDD preference handling in planning flow
  key_links:
    - from: commands/gsd/plan-phase.md
      to: agents/gsd-planner.md
      via: planner spawn prompt includes tdd_preference
      pattern: tdd_preference|tdd
---

<objective>
Add config-driven TDD preference so planner defaults to or prefers TDD plans when heuristic applies.

Purpose: TDD-02 — Planner produces TDD plans when heuristic applies (or by config preference).
Output: Config option, plan-phase passes it to planner, planner honors it.
</objective>

<execution_context>
@get-shit-done/workflows/execute-plan.md
@get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tdd-workflow/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tdd_preference to config schema</name>
  <files>.planning/config.json, get-shit-done/templates/config.json</files>
  <action>
Add `workflow.tdd_preference` to config:

1. In .planning/config.json: Add under workflow object:
   "tdd_preference": "default"

2. In get-shit-done/templates/config.json: Add under workflow object:
   "tdd_preference": "default"

Values: "default" (apply heuristic, create TDD when applicable), "always" (strict—must use TDD for testable features), "never" (skip TDD, use execute only).

Default when missing: "default" (backward compatible).
  </action>
  <verify>grep -l "tdd_preference" .planning/config.json get-shit-done/templates/config.json</verify>
  <done>Both config files have workflow.tdd_preference with value "default"</done>
</task>

<task type="auto">
  <name>Task 2: Pass tdd_preference to planner in plan-phase command</name>
  <files>commands/gsd/plan-phase.md</files>
  <action>
In commands/gsd/plan-phase.md, step 7 (Read Context Files) or step 8 (Spawn gsd-planner):

1. Add config read for tdd_preference:
   TDD_PREFERENCE=$(cat .planning/config.json 2>/dev/null | grep -o '"tdd_preference"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"\([^"]*\)"$/\1/' || echo "default")

2. In the planner spawn prompt (step 8), add to planning_context:
   **TDD Preference:** {tdd_preference}
   When "default": Apply TDD heuristic, create type:tdd plans when expect(fn(in)).toBe(out) applies.
   When "always": Prefer TDD for all testable features; use type:tdd unless clearly not applicable.
   When "never": Do not create TDD plans; use type:execute for all plans.

Ensure the filled prompt includes this so planner receives it.
  </action>
  <verify>grep -A2 "tdd_preference\|TDD Preference" commands/gsd/plan-phase.md</verify>
  <done>plan-phase reads tdd_preference and includes it in planner spawn prompt</done>
</task>

<task type="auto">
  <name>Task 3: Update gsd-planner to honor tdd_preference</name>
  <files>agents/gsd-planner.md</files>
  <action>
In agents/gsd-planner.md, update the TDD detection/heuristic section (or add new section) to:

1. Document that planner receives `tdd_preference` from orchestrator (plan-phase) in planning context.

2. Add decision logic before task breakdown:
   - If tdd_preference is "never": Skip TDD heuristic entirely; all plans get type: execute.
   - If tdd_preference is "default": Apply existing TDD heuristic (expect(fn(in)).toBe(out)? → TDD plan).
   - If tdd_preference is "always": Apply heuristic strictly; for any task where behavior is testable, MUST create type:tdd plan.

3. Ensure the existing TDD plan structure (type: tdd, wave, depends_on, etc.) is preserved. No changes to plan format.

4. Add to gather_phase_context or a new step: Parse TDD preference from planning context. If not provided, treat as "default".
  </action>
  <verify>grep -E "tdd_preference|always|never|default" agents/gsd-planner.md | head -5</verify>
  <done>Planner agent documents and applies tdd_preference when creating plans</done>
</task>

</tasks>

<verification>
- Config has tdd_preference in workflow
- plan-phase passes tdd_preference to planner
- Planner agent applies preference in TDD detection
</verification>

<success_criteria>
- TDD-02 satisfied: Planner produces TDD plans when heuristic applies (or by config)
- Config-driven behavior: default/always/never control TDD plan creation
- Backward compatible: missing config = default
</success_criteria>

<output>
After completion, create .planning/phases/02-tdd-workflow/02-01-SUMMARY.md
</output>
