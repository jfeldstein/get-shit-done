---
phase: 02-tdd-workflow
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/execute-plan.md
  - agents/gsd-executor.md
  - get-shit-done/references/tdd.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "TDD plan in project without tests shows checkpoint before any installation"
    - "User can choose 'setup' to install test infrastructure with consent"
    - "User can choose 'skip' to convert plan to standard execution"
    - "Skip only affects current plan, not global TDD behavior"
  artifacts:
    - path: "get-shit-done/workflows/execute-plan.md"
      provides: "tdd_infrastructure_check step with checkpoint logic"
      contains: "tdd_infrastructure_check"
    - path: "agents/gsd-executor.md"
      provides: "Checkpoint handling in tdd_execution section"
      contains: "test infrastructure"
    - path: "get-shit-done/references/tdd.md"
      provides: "Updated framework_setup referencing checkpoint"
      contains: "checkpoint"
  key_links:
    - from: "execute-plan.md tdd_infrastructure_check"
      to: "tdd_plan_execution"
      via: "Step runs BEFORE RED phase"
      pattern: "before.*RED"
    - from: "gsd-executor.md tdd_execution"
      to: "checkpoint_return_format"
      via: "Returns checkpoint if no test infrastructure"
      pattern: "checkpoint.*infrastructure"
---

<objective>
Add test infrastructure checkpoint for TDD plans in projects without tests.

Purpose: User explicitly decided that when a TDD plan runs in a project without test infrastructure, Claude should ASK before installing frameworks—not silently install them. This respects user agency and prevents unexpected changes.

Output: Modified execute-plan.md, gsd-executor.md, and tdd.md with checkpoint logic.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tdd-workflow/02-RESEARCH.md
@get-shit-done/references/checkpoints.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tdd_infrastructure_check step to execute-plan.md</name>
  <files>get-shit-done/workflows/execute-plan.md</files>
  <action>
Add a new step `<step name="tdd_infrastructure_check">` that runs BEFORE the existing `tdd_plan_execution` logic in the execute step.

**Location:** Add as a new step between `load_prompt` and `execute`, OR integrate into the beginning of `<tdd_plan_execution>` section (lines 907-963).

**The new step must:**

1. **Detection logic** — Check for test infrastructure using simple heuristics:
   - Node.js: Check package.json for test script (not "no test specified"), check devDependencies for jest/vitest/mocha
   - Python: Check requirements.txt/pyproject.toml for pytest, check for tests/ directory
   - Go: Check for *_test.go files
   - If ANY positive signal found → HAS_TESTS=true

2. **If HAS_TESTS=true:** Proceed normally to RED phase (no change from current behavior)

3. **If HAS_TESTS=false:** Present checkpoint using GSD format:

```
╔═══════════════════════════════════════════════════════╗
║  CHECKPOINT: Test Infrastructure Required             ║
╚═══════════════════════════════════════════════════════╝

This is a TDD plan but no test infrastructure was detected.

**Detected project type:** {Node.js | Python | Go | Rust | Unknown}

**Missing:**
- {specific missing items based on detection}

**Options:**

1. **setup** — I'll install {framework} and create minimal config, then proceed with TDD

2. **skip** — Convert this to standard execution (no tests, just implement the feature)

────────────────────────────────────────────────────────
→ YOUR ACTION: Type "setup" or "skip"
────────────────────────────────────────────────────────
```

4. **On "setup" response:** Continue to RED phase (install framework as part of RED)

5. **On "skip" response:** Convert plan to standard execution:
   - Ignore `type: tdd` frontmatter
   - Execute `<feature>` content as a standard `<task type="auto">`
   - Produce single feat() commit instead of test/feat/refactor

**IMPORTANT:** The existing "Check test infrastructure" code in `<tdd_plan_execution>` (lines 911-920) that silently installs must be wrapped in or replaced by this checkpoint logic. After checkpoint, if user chose "setup", THEN the framework installation proceeds.
  </action>
  <verify>
Grep execute-plan.md for "tdd_infrastructure_check" or "Test Infrastructure Required" — should find the new checkpoint logic.
Grep for the old silent install pattern "If no test framework configured:" and confirm it's now guarded by checkpoint.
  </verify>
  <done>
execute-plan.md contains tdd_infrastructure_check logic that presents checkpoint before any framework installation. The "setup" and "skip" paths are clearly documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add corresponding check to gsd-executor.md</name>
  <files>agents/gsd-executor.md</files>
  <action>
Update the `<tdd_execution>` section (lines 513-549) to include the test infrastructure checkpoint logic.

**Modify step "1. Check test infrastructure"** to:

1. Keep the detection logic
2. Add checkpoint handling when no tests found:

```markdown
**1. Check test infrastructure (before RED phase):**

Detect project type and check for existing test infrastructure:
- Node.js: package.json test script, jest/vitest/mocha in devDeps, *.test.* files
- Python: pytest in requirements, tests/ directory, *_test.py files
- Go: *_test.go files
- Rust: #[test] attributes

**If test infrastructure EXISTS:**
- Proceed to RED phase normally

**If NO test infrastructure:**
- Return checkpoint (type: decision)
- Options: "setup" (install framework, then TDD) or "skip" (standard execution)
- "skip" affects THIS PLAN ONLY, not global TDD preference

**On "setup":**
- Install minimal test framework
- Create config file
- Verify: run empty test suite
- Proceed to RED phase

**On "skip":**
- Convert plan to standard execution
- Execute <feature> as <task type="auto">
- Single feat() commit instead of test/feat/refactor cycle
```

**Also add checkpoint return format example** for this specific case under `<checkpoint_return_format>` or `<authentication_gates>` (as a similar pattern):

```markdown
**Example checkpoint for missing test infrastructure:**

```
## CHECKPOINT REACHED

**Type:** decision
**Plan:** {phase}-{plan}
**Progress:** 0/{total} tasks complete

### Current Task

**Task:** TDD Plan Execution
**Status:** blocked
**Blocked by:** No test infrastructure detected

### Checkpoint Details

**Decision needed:**
This TDD plan requires test infrastructure that wasn't found.

**Options:**

| Option | Action | Result |
|--------|--------|--------|
| setup | Install {Jest/pytest/etc.} and create config | Proceed with TDD (test→feat→refactor) |
| skip | Convert to standard execution | Single feat commit, no tests |

### Awaiting

Select: setup | skip
```
  </action>
  <verify>
Grep gsd-executor.md for "skip" and "setup" in the context of test infrastructure — should find the checkpoint options.
Grep for "THIS PLAN ONLY" or similar — confirms skip is not global.
  </verify>
  <done>
gsd-executor.md tdd_execution section documents the checkpoint for missing test infrastructure with setup/skip options, and clarifies skip is per-plan only.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tdd.md to reference checkpoint</name>
  <files>get-shit-done/references/tdd.md</files>
  <action>
Update the `<framework_setup>` section (lines 136-186) to reflect the new checkpoint-first behavior.

**Replace the current intro:**

Current (lines 136-139):
```
## Test Framework Setup (If None Exists)

When executing a TDD plan but no test framework is configured, set it up as part of the RED phase:
```

**New intro:**
```
## Test Framework Setup (If None Exists)

When executing a TDD plan in a project without test infrastructure, the executor presents a **checkpoint** before any installation:

**Checkpoint options:**
- **setup** — Install framework and config, then proceed with TDD cycle
- **skip** — Convert this plan to standard execution (no tests)

**Why checkpoint?** Silent installation changes project structure without consent. The checkpoint respects user agency — they may have reasons to skip TDD for this plan.

**Skip is per-plan only.** Choosing "skip" does NOT disable TDD globally; the next TDD plan will checkpoint again.

---

**If user chooses "setup":**
```

Keep all the existing framework setup content (detection, install commands, config files, etc.) but now it's clear this only happens AFTER the checkpoint with "setup" response.

**Add at the end of framework_setup section:**

```markdown
**If user chooses "skip":**

The executor converts the TDD plan to standard execution:
1. Ignores `type: tdd` frontmatter
2. Extracts implementation from `<feature><implementation>` element
3. Executes as standard task
4. Produces single `feat({phase}-{plan})` commit
5. No test file created

This is a graceful degradation, not a failure.
```
  </action>
  <verify>
Grep tdd.md for "checkpoint" — should appear in framework_setup section.
Grep for "skip" — should explain per-plan behavior.
  </verify>
  <done>
tdd.md framework_setup section now documents checkpoint-first behavior, explains setup vs skip options, and clarifies skip is per-plan only.
  </done>
</task>

</tasks>

<verification>
1. All three files modified with checkpoint logic
2. No remaining "silent install" code paths (all guarded by checkpoint)
3. "skip" behavior documented as per-plan only
4. Checkpoint format follows GSD conventions (from checkpoints.md)
</verification>

<success_criteria>
- execute-plan.md has tdd_infrastructure_check step with checkpoint
- gsd-executor.md tdd_execution section documents checkpoint + setup/skip handling
- tdd.md framework_setup section references checkpoint before installation
- Skip is explicitly documented as per-plan, not global
</success_criteria>

<output>
After completion, create `.planning/phases/02-tdd-workflow/02-03-SUMMARY.md`
</output>
