---
phase: 01-worktree-integration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - get-shit-done/workflows/execute-phase.md
autonomous: true

must_haves:
  truths:
    - After each executor completes, orchestrator merges agent branch into base branch
    - Orchestrator resolves merge conflicts (not subagent)
    - Worktree removed and agent branch deleted after successful merge
    - Test execution skipped before merge (per user decision)
  artifacts:
    - get-shit-done/workflows/execute-phase.md with merge and cleanup logic
  key_links: []
---

<objective>
Add merge and cleanup logic to execute-phase workflow after executor completes.

Purpose: Agent branches must be merged into base branch; worktrees removed. No test execution (user decision).
Output: Modified execute-phase.md with post-spawn merge, conflict resolution, and worktree removal.
</objective>

<execution_context>
@get-shit-done/workflows/execute-phase.md
@get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-worktree-integration/01-CONTEXT.md
@.planning/phases/01-worktree-integration/01-RESEARCH.md

User decisions: Orchestrator resolves conflicts; skip test execution
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add post-executor merge step</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
Add a new step (or extend execute_waves step 3 "Report completion") that runs AFTER each executor in a wave completes:

For each completed plan in the wave:
1. Merge agent branch into base branch: `git merge --no-ff "{agent_branch}" -m "Merge {agent_branch}: {plan_name}"`
2. If merge conflict:
   - Orchestrator resolves (user decision: not subagent rebase)
   - Document: "Orchestrator resolves conflicts manually, stages resolved files, completes merge"
   - Add retry/abort guidance if resolution fails
3. Delete agent branch: `git branch -d "{agent_branch}"` (after merge)
4. Remove worktree: `git worktree remove "wt/agent-{id}"` (or --force if uncommitted)

Skip test execution (per CONTEXT.md user decision).

Order: Merge all agent branches from wave, then remove worktrees. Base branch = current branch (or phase branch if branching strategy active).
  </action>
  <verify>grep -E "merge|worktree remove" get-shit-done/workflows/execute-phase.md</verify>
  <done>execute-phase.md contains post-spawn merge and cleanup logic</done>
</task>

<task type="auto">
  <name>Task 2: Integrate merge step into wave execution flow</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
Ensure the merge/cleanup step is correctly positioned in the execute-phase flow:

1. After "Wait for all agents in wave to complete"
2. Before "Report completion and what was built"
3. Add substep: "For each completed plan: merge agent branch → remove worktree → delete branch"

Update the step numbering/ordering if needed. The flow should be:
- Spawn executors (in worktrees)
- Wait for completion
- Merge each agent branch into base
- Remove worktrees
- Report completion

Ensure the workflow is clear about when merge happens (per-plan, after each wave).
  </action>
  <verify>Read execute-phase.md and confirm merge step order is correct</verify>
  <done>Merge and cleanup integrated into wave execution flow</done>
</task>

</tasks>

<verification>
- [ ] Post-spawn merge step exists
- [ ] Conflict resolution: orchestrator (documented)
- [ ] Test execution explicitly skipped
- [ ] Worktree remove and branch delete included
</verification>

<success_criteria>
- All tasks completed
- Merge/cleanup runs after each wave's executors complete
- No test execution step
</success_criteria>

<output>
After completion, create .planning/phases/01-worktree-integration/01-02-SUMMARY.md
</output>
