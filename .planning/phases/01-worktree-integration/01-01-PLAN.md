---
phase: 01-worktree-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/execute-phase.md
autonomous: true

must_haves:
  truths:
    - Before spawning gsd-executor, orchestrator creates worktree in wt/agent-xxx for each plan
    - Executor spawn prompt includes worktree path and "NEVER MODIFY REPO ROOT" instruction
    - Subagents work exclusively in their worktree directory
  artifacts:
    - get-shit-done/workflows/execute-phase.md with worktree creation and spawn-context logic
  key_links: []
---

<objective>
Add worktree creation and executor spawn context to execute-phase workflow.

Purpose: Executor subagents must run in isolated worktrees; repo root stays read-only.
Output: Modified execute-phase.md with pre-spawn worktree setup and worktree path in executor prompt.
</objective>

<execution_context>
@get-shit-done/workflows/execute-phase.md
@get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-worktree-integration/01-CONTEXT.md
@.planning/phases/01-worktree-integration/01-RESEARCH.md

Reference: parallel-agents-in-local-worktrees skill (branch naming, sanitization)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sanitize_branch_name and worktree setup step</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
Add a new step before execute_waves (or as first part of execute_waves) that:

1. Documents the sanitize_branch_name function (from RESEARCH.md) — include as bash block in workflow for orchestrator to use
2. Ensures wt/ directory exists: `mkdir -p wt`
3. For each plan in the wave, before spawning:
   - Generate 4-char agent ID (e.g., a1b2)
   - Sanitize plan slug from plan filename (e.g., 01-01-PLAN.md → 01-01)
   - Sanitize phase name for feature branch (e.g., worktree-integration)
   - Create branch name: feature--{phase-slug}--agents--agent-{id}--{plan-slug}
   - Create worktree: `git worktree add -b "{branch}" "wt/agent-{id}"`
   - Store mapping: plan_id → worktree_path, agent_branch for use in spawn and post-spawn

Place this logic in execute-phase.md. Use the step structure (name, bash blocks, instructions).
Do NOT implement in JavaScript — this is a markdown workflow document that the orchestrator (Claude) follows.
  </action>
  <verify>grep -A5 "worktree add" get-shit-done/workflows/execute-phase.md</verify>
  <done>execute-phase.md contains worktree creation logic before spawn</done>
</task>

<task type="auto">
  <name>Task 2: Add worktree path and repo-root contract to executor spawn prompt</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
Modify the executor spawn prompt section in execute-phase.md (execute_waves step, "Each agent gets prompt" part):

1. Add a required block to the prompt template:
   ```
   <worktree_context>
   Your working directory is: {worktree_path}
   All file operations, git commands, and edits MUST be in this directory.
   NEVER modify files outside this worktree. Repo root is READ ONLY.
   </worktree_context>
   ```

2. Add instruction: Orchestrator must substitute {worktree_path} with the actual path (e.g., wt/agent-a1b2 or absolute path) for each plan's spawn.

3. Add to success_criteria or context: "Executor runs all commands from worktree directory (cd to worktree before executing)."

The spawn prompt is inlined by the orchestrator — document that worktree_path must be inlined per-plan.
  </action>
  <verify>grep -A3 "worktree_context\|NEVER MODIFY REPO ROOT" get-shit-done/workflows/execute-phase.md</verify>
  <done>Executor spawn prompt includes worktree path and repo-root contract</done>
</task>

</tasks>

<verification>
- [ ] execute-phase.md has worktree creation step
- [ ] Executor prompt includes worktree_context block
- [ ] Branch naming follows feature--{phase}--agents--agent-{id}--{plan} pattern
</verification>

<success_criteria>
- All tasks completed
- Workflow document is coherent (orchestrator can follow it)
- No syntax errors in bash blocks
</success_criteria>

<output>
After completion, create .planning/phases/01-worktree-integration/01-01-SUMMARY.md
</output>
